# 開発AI向け指示書


# 1. テスト基盤の充実
* 現在、e2eテストはdocker exec 経由でテストコンテナ内のcurlを実行していますが、dev環境側にplaywrightとplaywright mcpを導入してテストをブラウザベースで実効できるようにします。

* container/tests/Dockerfileや.mcp.jsonにこれらのツールを導入してください。

# 2. e2eテスト整備続き
* e2eコンテナで実行しているplaywriteの画面をdevコンテナに接続されているvscode上で表示できるように設定してください

# 3. playwrite mcpでのテスト
* playwrite mcpを使ってwebコンテナのadminer bigquery pluginの問題点を洗い出してください。
* container/docs/を読んでテスト手順を確認してください。この開発環境はdood形式なので、http://[コンテナ名]で接続する必要があります。
* adminerコンテナの動作が遅いので、タイムアウトは20秒としてください。
* 既知の問題点は以下のようなものがあります。
    * playwriteで日本語が文字化けする(contaner/dev/Dockerfile で適切なfontsをインストールする)
    * テーブル構造の表示の際、type情報が全てnullになっている
    * select dataでデータを表示できない
* 既知の問題や新たに発見した問題も含め、改善レポートをcontainer/issues/report03.mdにまとめてください

# 4. 高速化のためのアイデア
* 現行のbigquery pluginはかなり全体的なパフォーマンスに難があり、データベースやテーブルの一覧、データの表示などが遅いです。
* コードと利用しているbigqueryコネクタを解析し、高速化のためのアイデアを出してcontainer/issues/report04.mdにまとめてください
* 以下の観点や、一般的なアイデアから検討してください。
    * どの処理が遅いか、の計測
    * できるだけまとめて取得(N+1にならないようにする)
    * より高速に実行できるコーディング(ループ処理や分岐処理の改善)
    * コネクタやオブジェクトの再利用
    * キャッシュ機構の導入
    * プリロード
    * 別のbigqueryコネクタの利用
    * APIやbqの直接利用

# 5. 高速化実装
container/issues/report04.md を参考に高速化を実行してください

# 6. 計測
* 実装されたProfilerを利用して、どの処理に時間が掛っているかを計測し、container/issues/report05.md で報告してください。

# 7. ボトルネック解消
* 手元のブラウザではあまり効果がなく、全体的に遅いように感じます。
* container/issues/report05.md でボトルネックと報告されているBigQuery API接続確立を高速化する方法について検討し実装してください。

# 8. Profilerの除去
* BigQueryProfilerを含む処理時間計測は役割を終えたのでコードから完全に除去してください。


# 9. apcu警告
なるほど！
今度は Intelephense の **P1010: Undefined function 'apcu\_exists'** ですね。

これは **APCu 拡張がインストールされていない / Intelephense に認識されていない** ために出ています。
実行環境に APCu があっても、Intelephense は「関数のシグネチャを知らない」ので警告を出します。

---

## 解決方法

### ✅ 実際に APCu を使う予定がある場合

1. **APCu 拡張をインストール**
   Linux + PHP なら：

   ```bash
   sudo apt-get install php-apcu
   # または
   pecl install apcu
   ```

   その後 `php.ini` に追記：

   ```ini
   extension=apcu.so
   ```

2. **Intelephense に APCu の stubs を認識させる**
   APCu の `.php` スタブファイルを用意して `intelephense.stubs` に登録します。

   例: `.vscode/settings.json` に追加

   ```json
   {
     "intelephense.stubs": [
       "apache",
       "bcmath",
       "bz2",
       "calendar",
       "com_dotnet",
       "Core",
       "apcu"
     ]
   }
   ```

   👉 `apcu` がデフォルトに含まれていないので、手動で追加します。

   APCu の stubs は GitHub や Packagist にあるのでダウンロードして `vendor/php-stubs/apcu-stubs` などに入れるとよいです。
   （`composer require --dev php-stubs/apcu-stubs` で簡単に導入可能）

---

### ✅ 実行環境で APCu を使わない場合

つまり「エディタ上の警告だけ消したい」なら：

1. `.vscode/settings.json` にて **undefinedFunctions を無効化**

   ```json
   {
     "intelephense.diagnostics.undefinedFunctions": false
   }
   ```

   これで `apcu_exists` 警告は消えますが、他の未定義関数も検出されなくなります。

2. **ダミー関数を定義**
   `bigquery.php` の先頭に条件付きで定義：

   ```php
   if (!function_exists('apcu_exists')) {
       function apcu_exists(string $key): bool { return false; }
   }
   ```

   👉 実際には APCu がある環境では本物が使われ、Intelephense には「存在する」と認識されます。

---

## おすすめのやり方

* 本当に APCu を使う → `composer require --dev php-stubs/apcu-stubs`
