# E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œç”¨Dockerfile - ã‚¹ã‚¯ãƒªãƒ—ãƒˆæŒ‡å®šå®Ÿè¡Œå‹
FROM mcr.microsoft.com/playwright:v1.48.1-focal

# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update && apt-get install -y \
    curl \
    jq \
    git \
    && rm -rf /var/lib/apt/lists/*

# Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
WORKDIR /app

# package.jsonã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY container/e2e/package.json ./
COPY container/e2e/playwright.config.js ./

# ãƒ­ãƒ¼ã‚«ãƒ«ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN npm install

# Playwrightãƒ–ãƒ©ã‚¦ã‚¶ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN npx playwright install chromium firefox webkit

# ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
RUN mkdir -p /app/tests
RUN mkdir -p /app/scripts

# åŸºæœ¬ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
COPY container/e2e/tests/basic-flow-test.spec.js /app/tests/

# ç’°å¢ƒå¤‰æ•°è¨­å®š
ENV NODE_ENV=test
ENV PLAYWRIGHT_BROWSERS_PATH=/ms-playwright

# DooDå¯¾å¿œã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆï¼ˆæ¨™æº–å…¥å‡ºåŠ›ã®ã¿ä½¿ç”¨ï¼‰
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "ğŸš€ E2E ãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹: $(date)" >&2\n\
echo "ç’°å¢ƒ: $NODE_ENV" >&2\n\
echo "ãƒ™ãƒ¼ã‚¹URL: $BASE_URL" >&2\n\
\n\
# æ¨™æº–å…¥åŠ›ã‹ã‚‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’èª­ã¿è¾¼ã‚“ã§å®Ÿè¡Œ\n\
if [ "$1" = "--stdin" ]; then\n\
  echo "ğŸ“‹ æ¨™æº–å…¥åŠ›ã‹ã‚‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ" >&2\n\
  # æ¨™æº–å…¥åŠ›ã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜\n\
  cat > /tmp/test_script.sh\n\
  chmod +x /tmp/test_script.sh\n\
  echo "ğŸ“‚ ã‚¹ã‚¯ãƒªãƒ—ãƒˆä¿å­˜å®Œäº†ã€å®Ÿè¡Œé–‹å§‹" >&2\n\
  # ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œçµæœã‚’æ¨™æº–å‡ºåŠ›ã«å‡ºåŠ›\n\
  bash /tmp/test_script.sh\n\
elif [ "$1" != "" ]; then\n\
  echo "ğŸ“‹ ç›´æ¥ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ: $*" >&2\n\
  # ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œçµæœã‚’æ¨™æº–å‡ºåŠ›ã«å‡ºåŠ›\n\
  exec "$@"\n\
else\n\
  echo "ğŸ“‹ å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰" >&2\n\
  # ãƒ†ã‚¹ãƒˆçµæœã‚’æ¨™æº–å‡ºåŠ›ã«å‡ºåŠ›\n\
  npx playwright test --reporter=line\n\
fi\n\
\n\
echo "âœ… E2E ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº†: $(date)" >&2' > /app/entrypoint.sh

# å®Ÿè¡Œæ¨©é™ä»˜ä¸
RUN chmod +x /app/entrypoint.sh

# ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆè¨­å®š
ENTRYPOINT ["/app/entrypoint.sh"]