#!/bin/bash
set -e

echo "ðŸš€ E2E ãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹: $(date)" >&2
echo "ðŸ“¦ E2Eç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­..." >&2

# E2Eç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆçµ±ä¸€ã•ã‚ŒãŸä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½¿ç”¨ï¼‰
echo "ðŸ“¦ E2Eç’°å¢ƒã¯æ—¢ã«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ¸ˆã¿ã§ã™ï¼ˆDockerçµ±ä¸€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½¿ç”¨ï¼‰" >&2
echo "ðŸ“ ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: /app/devtools/e2e" >&2

echo "ç’°å¢ƒ: $NODE_ENV" >&2
echo "ãƒ™ãƒ¼ã‚¹URL: $BASE_URL" >&2

# ãƒ†ã‚¹ãƒˆçµæžœä¿å­˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
mkdir -p ./test-results
echo "ðŸ“ ãƒ†ã‚¹ãƒˆçµæžœä¿å­˜å…ˆ: /app/devtools/e2e/test-results" >&2

# ã‚³ãƒ³ãƒ†ãƒŠå†…ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ã¦ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¾ãŸã¯ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
if [ -f "$1" ]; then
  echo "ðŸ“‹ ãƒ•ã‚¡ã‚¤ãƒ«å®Ÿè¡Œ: $1" >&2
  # .spec.jsãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã¯Playwrightãƒ†ã‚¹ãƒˆã¨ã—ã¦å®Ÿè¡Œ
  if [[ "$1" == *.spec.js ]]; then
    echo "ðŸ“‹ Playwrightãƒ†ã‚¹ãƒˆå®Ÿè¡Œ: $1" >&2
    # ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ç›¸å¯¾ãƒ‘ã‚¹ã‚’è¨ˆç®—ã—ã¦å®Ÿè¡Œ
    TEST_FILE=$(basename "$1")
    npx playwright test "tests-full/$TEST_FILE" --project=chromium --reporter=line
  else
    echo "ðŸ“‹ ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«å®Ÿè¡Œ: $1" >&2
    # é€šå¸¸ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œ
    bash "$1"
  fi
elif [ "$1" != "" ]; then
  echo "ðŸ“‹ ç›´æŽ¥ã‚³ãƒžãƒ³ãƒ‰å®Ÿè¡Œ: $*" >&2
  # ã‚³ãƒžãƒ³ãƒ‰å®Ÿè¡Œçµæžœã‚’æ¨™æº–å‡ºåŠ›ã«å‡ºåŠ›
  exec "$@"
else
  echo "ðŸ“‹ å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰" >&2
  # å…¨ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
  npx playwright test --reporter=line
fi

echo "âœ… E2E ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº†: $(date)" >&2