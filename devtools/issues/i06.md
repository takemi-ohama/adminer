# 開発AI向け指示書


# 1. bigqueryの認証をGoogle OAuth2認証に変更
* bigquery.php の認証関連の仕様を追加します。

* 環境変数"GOOGLE_OAUTH2_ENABLE"がtureだった場合、Google OAuth2認証方式とします。
	true以外の値または未設定の場合は従来通りのCREDENTIALによる認証となります。

* Google OAuth2認証方式の場合、画面は「Sign in with Google」ボタンとロゴのみとしてください。
    * https://adminer.dev.car-mo.jp/ のログイン画面を参考にしてください

* Google OAuth2認証で認証してください。OAuth2認証で必要なパラメータは以下の環境変数に設定するものとします。
	"GOOGLE_OAUTH2_ENABLE":
	"GOOGLE_OAUTH2_CLIENT_ID":
	"GOOGLE_OAUTH2_REDIRECT_URL":
	"GOOGLE_OAUTH2_COOKIE_DOMAIN":
	"GOOGLE_OAUTH2_COOKIE_NAME":
	"GOOGLE_OAUTH2_COOKIE_EXPIRE":
	"GOOGLE_OAUTH2_COOKIE_SECRET":

* 環境変数"GOOGLE_OAUTH2_ENABLE"がtureの場合、Google OAuth2認証で認証されたユーザの権限を使ってbigqueryの認証・認可を得るようにしてください。


# 2. cdkの移植
* 現在、本番環境用に以下のcdk stackが構成されています
	* https://github.com/volareinc/carmo-cdk/blob/main/py-infra/stacks/adminer_gbq.py
* これを、このワークスペースのdevtools/cdk に移植してください。



# 3. クラス分離
* bigquery.php に含まれているクラスをファイルに分割します。
* 1クラスつづ作業します。今回はAdminerLoginBigQueryクラスを分離します。
* 分離されたファイルはplugins/drivers/bigquery/に配置してください
* namespace Adminer; であることに注意してください
* 分離されたら、


# 4. SQL発行メソッドの共通化
* truncate_table()やalter_table()など、sqlを発行するfunctionでconnectionやtableのチェックが重複しています。
* SQLを受け取って実行するメソッドを適切なクラス内に作成し、グローバルfunctionではSQL文をそのメソッドに渡すだけにしてください。
* adminer/drivers/mysql.inc.php を参考にしてください。
* bigquery.php内のすべてのfunctionについて、同様の冗長コード排除を行ってください


# 3. クラス分離ソノ２　
* bigquery.php に含まれているクラスをファイルに分割します。
* 1クラスつづ作業します。今回はAdminerLoginBigQueryクラスを分離します。
* 分離されたファイルはplugins/drivers/bigquery/に配置してください
* namespace Adminer; であることに注意してください
* 分離されたら、/test-webコマンドでテストしてください
