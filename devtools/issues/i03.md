# 開発AI向け指示書

# 1. project_idを環境変数から受け取るよう修正
* /home/ubuntu/work/adminer/devtools/web/compose.yml
で環境変数GOOGLE_CLOUD_PROJECTの値を変更しました。

* 以下の2つのファイルで、project_idを直接指定している箇所があるようです。
* project_idはindex.phpでGOOGLE_CLOUD_PROJECTから読み取るようにし、login-bigquery.phpは変数としてその情報を受け取るようにしてください。
	* devtools/web/index.php
	* devtools/web/plugins/login-bigquery.php
* デフォルト値の設定は不要です。


# 2. credentials_pathも環境変数から
* credentials_pathも環境変数から読み取るようにしてください。
* または、GOOGLE_APPLICATION_CREDENTIALSは公式の認証パス環境変数なので、そもそも設定自体不要な可能性があります。
	* 調査して不要であれば設定しないようにしてください。

# 3. 未実装機能の実装
* ソート、編集、作成、ダウンロードなどの機能が未実装です。すべての機能を実装してください。
* container/e2eコンテナを使って、すべてのメニューやボタン、リンクをテストするe2eテストシナリオを作成してください。
	* e2eコンテナのplaywriteを使ってテストをしてください。
	* playwrite mcpはtokenがオーバーフローしやすいので、使わないこと。
* 参照系のテストとデータセットやテーブル、レコードを作成、編集、削除する更新系のテストは別シナリオとしてください。
	* レコード作成や、編集、削除といった操作はデータベース(bigqueryのデータセット)とテーブルをそれぞれ新規作成し、そこに作成されたレコードに対してのみ行うようにしてください。
	* データベースの削除は実装しないままで構いません。
* 参照系のテストシナリオを実行し、エラーがなくなるまで機能を修正してください。
* 参照系が完了したら更新系のテストシナリオを実行し、エラーがなくなるまで機能を修正してください。
* すべてのエラーがなくなったら終了です。
* エラーは画面とログの双方で確認してください。
* Tokenオーバーフローなどでの中断に備えて、実行状況はこまめにserena mcpとUPDATE.mdに記憶しておいてください。
	* この指示を見た場合はserena mcpとUPDATE.mdをチェックしてください

* 「参照系機能は完全に動作し、更新系機能（INSERT/UPDATE/DELETE）も実装完了しています。」という報告がありましたが、実装もe2eテストも足りていません。画面に表示されるすべてのリンクやボタンのクリック、フォーム入力を試すテストを作成し、確実に実装を進めてください。

* 現状以下が実装されていません。(名称は表示言語を「English」とししたときの表記です)
	* 左メニュー「DB:」のデータベース切り替え機能→選択しても画面が切り替わらない
	* 左メニュー「SQL  command」で表示されるSQL command画面→SQLを実行しても常に結果が0件
		* http://localhost:8080/?bigquery=adminer-test-472623&username=bigquery-service-account&db=adminer_test_dataset_1758379640314&sql=
	* 左メニュー「Import」未実装
	* 左メニュー「Export」未実装
	* Database画面のメニュー「Database schema」→Fatal error(未実装)
		* http://localhost:8080/?bigquery=adminer-test-472623&username=bigquery-service-account&db=test_dataset_fixed_api&schema=
	* Database画面「Search data in tables」のボタン「Search」→未実装
		* http://localhost:8080/?bigquery=adminer-test-472623&username=bigquery-service-account&db=test_dataset_fixed_api
	* Database画面「Move to other database」の「Move」ボタン→Fatal error(未実装)
		* http://localhost:8080/?bigquery=adminer-test-472623&username=bigquery-service-account&db=test_dataset_fixed_api
		* Fatal error: Uncaught Error: Call to undefined function Adminer\move_tables() in /var/www/html/adminer/db.inc.php:19 Stack trace: #0 /var/www/html/adminer/index.php(78): include() #1 /var/www/html/index.php(33): include('...') #2 {main} thrown in /var/www/html/adminer/db.inc.php on line 19
	* Database画面「Selected」の「Analyze」「Optimize」...の各ボタン全て→未実装
	* Table画面「Alter Table」→カラムが表示されない
		* http://localhost:8080/?bigquery=adminer-test-472623&username=bigquery-service-account&db=test_dataset_fixed_api&create=test_sanitized_table
	* Select画面「Search」ボタン
		* http://localhost:8080/?bigquery=adminer-test-472623&username=bigquery-service-account&db=test_dataset_fixed_api&select=test_sanitized_table&columns%5B0%5D%5Bcol%5D=&where%5B0%5D%5Bcol%5D=name&where%5B0%5D%5Bop%5D=%3D&where%5B0%5D%5Bval%5D=Test+Record+Name&order%5B0%5D=&limit=50&text_length=100
* まだまだ未実装があるので、調査して実装を進めてください。
* bigqueryでサポートされていない機能については、リンクやボタンをクリック後その旨を画面に表示するか、リンク、ボタン自体をdisableやinvisibleにしてください。

* 一つの機能を実装するごとにUPDATE.mdを更新してください


# 4. e2eテストの手法確立
* 未実装機能の実装前に、e2eテストを安定して実行できる環境の構築が必要です。
* container/e2eのコンテナは常駐型ではなく、スクリプトを指定して自動的にテストが実行される形式とします。
	* コンテナにスクリプトを指定して起動すると、自動的にテストが実行されるようにentrypoint, commandを設定
	* スクリプトはvolumeでマウントする
	* テスト結果は標準出力に出力
* このコンテナを起動し、ログを所定の場所に保存するshell scriptも作成
* このコンテナを使ったテスト手順をCLAUDE.mdとserena mcp、docs/に記録
	* これまで記憶したテスト手順は混乱のもとになるので痕跡を残さず削除する


# 5. 基本機能のテストスクリプト作成
* http://adminer-bigquery-test/ に接続し、ログインし、任意のデータベースとテーブルを選択してデータ一覧を表示するテストスクリプトを作成してください。
* スクリプトをe2eコンテナで実行し、エラーなく動作するかどうか確認してください。


# 6. devコンテナとe2eコンテナでのvolume共有
* container/dev/compose.yml で、名前付きvolumeを定義して/home/ubuntu/workにmountするようにしてください。
* container/e2e/compose.yml で、上記で作成された名前付きボリュームをexternalで指定し、/appにmountしてください。
	* compose.ymlで名前付きvolumeを作成すると、外部から見たvolume名は[プロジェクト名]_[volume名]となることに注意
* この設定で、devコンテナとe2eコンテナはスクリプトなどが共有されます。
* このvolumeの存在を前提として、e2eコンテナとその起動シェルスクリプト、テスト手順を書き換えてください。

# 7. UPDATE.mdに基づく実装
* 現状に合わせてUPDATE.mdを更新してください
* UPDATE.mdを参照して実装を続けてください。
* 次の実装計画を立ててUPDATE.mdを更新してください
